# 4ì¼ì°¨: Preload Scriptì™€ IPC í†µì‹ 

## í•™ìŠµ ëª©í‘œ
- Preload Scriptì˜ ì—­í• ê³¼ ì¤‘ìš”ì„±ì„ ì´í•´í•œë‹¤
- Context Bridgeë¥¼ í†µí•œ ì•ˆì „í•œ API ë…¸ì¶œì„ í•™ìŠµí•œë‹¤
- IPC í†µì‹ ì˜ ë³´ì•ˆ ëª¨ë¸ì„ ì´í•´í•œë‹¤
- preload.tsì˜ êµ¬ì¡°ì™€ íŒ¨í„´ì„ ë¶„ì„í•œë‹¤

## ì´ë¡  í•™ìŠµ

### Preload Scriptì˜ ê°œë…

#### 1. ì‹¤í–‰ í™˜ê²½ê³¼ ì‹œì 
- **Main Worldì™€ Isolated World ì‚¬ì´**ì—ì„œ ì‹¤í–‰
- **DOMì´ ë¡œë“œë˜ê¸° ì „**ì— ì‹¤í–‰
- **Renderer Processê°€ ì‹œì‘ë  ë•Œ** ìë™ ë¡œë“œ
- **Node.js API ì ‘ê·¼ ê°€ëŠ¥**í•˜ì§€ë§Œ ì œí•œì 

#### 2. ë³´ì•ˆ ëª¨ë¸ì˜ í•µì‹¬
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Main Process  â”‚â—„â”€â”€â–ºâ”‚ Preload Script   â”‚â—„â”€â”€â–ºâ”‚ Renderer Processâ”‚
â”‚                 â”‚ IPC â”‚                  â”‚API â”‚                 â”‚
â”‚ (Node.js ì™„ì „)  â”‚    â”‚ (ì œí•œëœ Node.js) â”‚    â”‚ (ë¸Œë¼ìš°ì € í™˜ê²½)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë³´ì•ˆ ì›ì¹™:**
- **ìµœì†Œ ê¶Œí•œ ì›ì¹™**: í•„ìš”í•œ APIë§Œ ë…¸ì¶œ
- **ì…ë ¥ ê²€ì¦**: ëª¨ë“  ë°ì´í„° ê²€ì¦ í›„ ì „ë‹¬
- **íƒ€ì… ì•ˆì „ì„±**: TypeScriptë¡œ ê³„ì•½ ì •ì˜

#### 3. Context Bridge íŒ¨í„´
```typescript
contextBridge.exposeInMainWorld('electronAPI', {
  // ì•ˆì „í•˜ê²Œ ë…¸ì¶œí•  APIë§Œ ì„ ë³„
  getStreamers: () => ipcRenderer.invoke('get-streamers'),
  addStreamer: (data) => ipcRenderer.invoke('add-streamer', data)
});
```

## ì½”ë“œ ë¶„ì„

### preload.tsì˜ êµ¬ì¡° ë¶„ì„

#### 1. API ê°ì²´ ì„¤ê³„

```typescript
const electronAPI = {
  // ìŠ¤íŠ¸ë¦¬ë¨¸ ê´€ë ¨
  getStreamers: () => ipcRenderer.invoke('get-streamers'),
  addStreamer: (streamerData: any) => ipcRenderer.invoke('add-streamer', streamerData),
  updateStreamer: (streamerData: any) => ipcRenderer.invoke('update-streamer', streamerData),
  deleteStreamer: (streamerId: number) => ipcRenderer.invoke('delete-streamer', streamerId),

  // ì•Œë¦¼ ê´€ë ¨  
  getNotifications: (options?: any) => ipcRenderer.invoke('get-notifications', options),
  deleteAllNotifications: () => ipcRenderer.invoke('delete-all-notifications'),
  // ...
};
```

**ì„¤ê³„ íŠ¹ì§•:**
- **ë„ë©”ì¸ë³„ ê·¸ë£¹í™”**: ê¸°ëŠ¥ë³„ë¡œ API ë¶„ë¥˜
- **ì¼ê´€ëœ ë„¤ì´ë°**: ë™ì‚¬ + ëª…ì‚¬ íŒ¨í„´
- **íƒ€ì… íŒíŠ¸**: TypeScriptë¡œ ë§¤ê°œë³€ìˆ˜ íƒ€ì… ì •ì˜#### 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ íŒ¨í„´

```typescript
// íŠ¹ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
onStreamerDataUpdated: (callback: (streamers: any[]) => void) => {
  ipcRenderer.on('streamer-data-updated', (_, streamers) => callback(streamers));
},

// ë²”ìš© ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
on: (channel: string, callback: (...args: any[]) => void) => {
  ipcRenderer.on(channel, (_, ...args) => callback(...args));
},

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•´ì œ
removeListener: (channel: string, callback: (...args: any[]) => void) => {
  ipcRenderer.removeListener(channel, callback);
}
```

**íŒ¨í„´ ë¶„ì„:**
- **ì´ë²¤íŠ¸ ë˜í•‘**: ipcRenderer ì´ë²¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ë˜í•‘
- **ì¸ìˆ˜ ì •ë¦¬**: `_` (event ê°ì²´)ë¥¼ ì œê±°í•˜ê³  ì‹¤ì œ ë°ì´í„°ë§Œ ì „ë‹¬
- **ë©”ëª¨ë¦¬ ê´€ë¦¬**: ë¦¬ìŠ¤ë„ˆ í•´ì œ ê¸°ëŠ¥ ì œê³µ

#### 3. íƒ€ì… ì•ˆì „ì„± ë³´ì¥

```typescript
// TypeScript íƒ€ì… ì„ ì–¸
declare global {
  interface Window {
    electronAPI: typeof electronAPI;
  }
}
```

**íƒ€ì… ì„ ì–¸ì˜ íš¨ê³¼:**
- **ì»´íŒŒì¼ íƒ€ì„ ê²€ì¦**: ì˜ëª»ëœ API í˜¸ì¶œ ë°©ì§€
- **IntelliSense ì§€ì›**: IDEì—ì„œ ìë™ì™„ì„± ì œê³µ
- **ë¬¸ì„œí™”**: API êµ¬ì¡°ë¥¼ ì½”ë“œë¡œ ë¬¸ì„œí™”

#### 4. ê°œë°œì ë„êµ¬ í†µí•©

```typescript
// ê°œë°œì ì½˜ì†”ì—ì„œ ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥í•œ ìœ í‹¸ë¦¬í‹°
contextBridge.exposeInMainWorld('clearWeverseData', async () => {
  console.log('ğŸ§¹ ìœ„ë²„ìŠ¤ ì•Œë¦¼ ë°ì´í„° í´ë¦¬ì–´ ì¤‘...');
  try {
    const result = await electronAPI.clearWeverseData();
    if (result.success) {
      console.log('âœ… ìœ„ë²„ìŠ¤ ì•Œë¦¼ ë°ì´í„° í´ë¦¬ì–´ ì™„ë£Œ');
    } else {
      console.error('âŒ ìœ„ë²„ìŠ¤ ì•Œë¦¼ ë°ì´í„° í´ë¦¬ì–´ ì‹¤íŒ¨:', result.error);
    }
    return result;
  } catch (error) {
    console.error('âŒ ìœ„ë²„ìŠ¤ ì•Œë¦¼ ë°ì´í„° í´ë¦¬ì–´ ì‹¤íŒ¨:', error);
    return { success: false, error: String(error) };
  }
});
```

**ê°œë°œì í¸ì˜ ê¸°ëŠ¥:**
- **ë””ë²„ê¹… í•¨ìˆ˜**: ì½˜ì†”ì—ì„œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥
- **ë¡œê¹… í†µí•©**: ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœë¥¼ ëª…í™•íˆ í‘œì‹œ
- **ì—ëŸ¬ ì²˜ë¦¬**: ì˜ˆì™¸ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬

### IPC í†µì‹  íŒ¨í„´ ë¶„ì„

#### 1. Request-Response íŒ¨í„´ (invoke/handle)

```typescript
// Preload: ìš”ì²­ ì „ì†¡
getStreamers: () => ipcRenderer.invoke('get-streamers')

// Main: ì‘ë‹µ ì²˜ë¦¬  
ipcMain.handle('get-streamers', async () => {
  const result = await this.databaseManager.getStreamers();
  return result;
});
```

**íŠ¹ì§•:**
- **ë¹„ë™ê¸° í†µì‹ **: Promise ê¸°ë°˜
- **ì–‘ë°©í–¥**: ìš”ì²­ê³¼ ì‘ë‹µ ëª¨ë‘ ì¡´ì¬
- **ì—ëŸ¬ ì „íŒŒ**: ìë™ìœ¼ë¡œ ì˜ˆì™¸ ì „íŒŒ

#### 2. Event Broadcasting íŒ¨í„´ (send/on)

```typescript
// Main: ì´ë²¤íŠ¸ ë°œì†¡
this.mainWindow.webContents.send('notification-history-updated', notifications);

// Preload: ì´ë²¤íŠ¸ ìˆ˜ì‹  ë˜í•‘
on: (channel: string, callback: (...args: any[]) => void) => {
  ipcRenderer.on(channel, (_, ...args) => callback(...args));
}
```

**íŠ¹ì§•:**
- **ë‹¨ë°©í–¥**: Main â†’ Renderer
- **ì‹¤ì‹œê°„**: ì¦‰ì‹œ ì•Œë¦¼
- **ë©€í‹°ìºìŠ¤íŠ¸**: ì—¬ëŸ¬ ë Œë”ëŸ¬ì— ë™ì‹œ ì „ì†¡ ê°€ëŠ¥

## ì‹¤ìŠµ ì˜ˆì œ

### ì‹¤ìŠµ 1: ê°œë°œì ì½˜ì†”ì—ì„œ API í…ŒìŠ¤íŠ¸

1. **ì•± ì‹¤í–‰ í›„ ê°œë°œì ë„êµ¬ ì—´ê¸°:**
```bash
npm run dev
# F12ë¡œ ê°œë°œì ë„êµ¬ ì—´ê¸°
```

2. **ì½˜ì†”ì—ì„œ API ì§ì ‘ í˜¸ì¶œ:**
```javascript
// ê¸°ë³¸ API í…ŒìŠ¤íŠ¸
await window.electronAPI.getStreamers()
await window.electronAPI.getSettings()
await window.electronAPI.getUnreadCount()

// ê°œë°œì ìœ í‹¸ë¦¬í‹° í…ŒìŠ¤íŠ¸
await clearWeverseData()
await diagnosticWeverseDatabase()
```

### ì‹¤ìŠµ 2: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í…ŒìŠ¤íŠ¸

1. **ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡:**
```javascript
// ì½˜ì†”ì—ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
window.electronAPI.on('notification-received', (notification) => {
  console.log('ìƒˆ ì•Œë¦¼:', notification);
});

window.electronAPI.on('live-status-updated', (statuses) => {
  console.log('ë¼ì´ë¸Œ ìƒíƒœ ì—…ë°ì´íŠ¸:', statuses);
});
```

2. **ì´ë²¤íŠ¸ ë°œìƒ ì‹œí‚¤ê¸°:**
- í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡: Settings í˜ì´ì§€ì—ì„œ "í…ŒìŠ¤íŠ¸ ì•Œë¦¼" ë²„íŠ¼ í´ë¦­
- ìŠ¤íŠ¸ë¦¬ë¨¸ ì •ë³´ ë³€ê²½: ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ

### ì‹¤ìŠµ 3: íƒ€ì… ê²€ì¦ í…ŒìŠ¤íŠ¸

1. **ì˜¬ë°”ë¥¸ íƒ€ì…ìœ¼ë¡œ í˜¸ì¶œ:**
```javascript
await window.electronAPI.addStreamer({
  name: 'Test Streamer',
  chzzkId: 'test123',
  isActive: true
});
```

2. **ì˜ëª»ëœ íƒ€ì…ìœ¼ë¡œ í˜¸ì¶œí•˜ì—¬ ì—ëŸ¬ í™•ì¸:**
```javascript
// í•„ìˆ˜ í•„ë“œ ëˆ„ë½ í…ŒìŠ¤íŠ¸
await window.electronAPI.addStreamer({
  chzzkId: 'test123'  // name í•„ë“œ ëˆ„ë½
});
```## ê³¼ì œ

### ê³¼ì œ 1: Context Bridge ë³´ì•ˆ ë¶„ì„

ë‹¤ìŒ ë‘ ì ‘ê·¼ ë°©ì‹ì„ ë¹„êµí•˜ê³  ë³´ì•ˆìƒì˜ ì°¨ì´ì ì„ ì„¤ëª…í•˜ì„¸ìš”:

**ë°©ì‹ A (ì•ˆì „í•˜ì§€ ì•ŠìŒ):**
```typescript
// nodeIntegration: trueì¸ ê²½ìš°
window.require = require;
window.fs = require('fs');
```

**ë°©ì‹ B (ì•ˆì „í•¨):**
```typescript
// contextBridge ì‚¬ìš©
contextBridge.exposeInMainWorld('electronAPI', {
  readFile: (path: string) => ipcRenderer.invoke('read-file', path)
});
```

**ì§ˆë¬¸:**
1. **ë°©ì‹ Aì˜ ë³´ì•ˆ ìœ„í—˜ì€ ë¬´ì—‡ì¸ê°€?**
2. **ë°©ì‹ Bê°€ ì•ˆì „í•œ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€?**
3. **Context Isolationì´ ì–´ë–¤ ì—­í• ì„ í•˜ëŠ”ê°€?**

### ê³¼ì œ 2: IPC íŒ¨í„´ ì„¤ê³„

ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ëŠ” ìƒˆë¡œìš´ IPC APIë¥¼ ì„¤ê³„í•´ë³´ì„¸ìš”:

**ìš”êµ¬ì‚¬í•­:**
- **íŒŒì¼ ê´€ë¦¬ ê¸°ëŠ¥**: íŒŒì¼ ì½ê¸°, ì“°ê¸°, ì‚­ì œ
- **ë³´ì•ˆ ê³ ë ¤**: íŠ¹ì • ë””ë ‰í† ë¦¬ ì™¸ë¶€ ì ‘ê·¼ ê¸ˆì§€
- **ì—ëŸ¬ ì²˜ë¦¬**: íŒŒì¼ ì—†ìŒ, ê¶Œí•œ ì—†ìŒ ë“± ìƒí™©ë³„ ì—ëŸ¬ ì²˜ë¦¬

```typescript
// preload.tsì— ì¶”ê°€í•  API ì„¤ê³„
const fileAPI = {
  // ì—¬ëŸ¬ë¶„ì´ ì„¤ê³„í•´ë³´ì„¸ìš”!
  readFile: (filename: string) => { /* ... */ },
  writeFile: (filename: string, content: string) => { /* ... */ },
  deleteFile: (filename: string) => { /* ... */ },
  listFiles: () => { /* ... */ }
};
```

### ê³¼ì œ 3: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë©”ëª¨ë¦¬ ê´€ë¦¬

ë‹¤ìŒ ì½”ë“œì—ì„œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±ì„ ì°¾ê³  í•´ê²° ë°©ì•ˆì„ ì œì‹œí•˜ì„¸ìš”:

```typescript
const MyComponent: React.FC = () => {
  const [data, setData] = useState([]);

  useEffect(() => {
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    window.electronAPI.on('data-updated', (newData) => {
      setData(newData);
    });

    window.electronAPI.on('status-changed', (status) => {
      console.log('Status:', status);
    });
    
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    window.electronAPI.getData().then(setData);
  }, []);

  return <div>{/* UI */}</div>;
};
```

**ë¬¸ì œì ê³¼ í•´ê²°ë°©ì•ˆ:**
1. **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±ì„ ì°¾ì•„ë³´ì„¸ìš”**
2. **ì˜¬ë°”ë¥¸ ì •ë¦¬ ë°©ë²•ì„ êµ¬í˜„í•´ë³´ì„¸ìš”**
3. **ì»´í¬ë„ŒíŠ¸ ì¬ë§ˆìš´íŠ¸ ì‹œ ë¬¸ì œì ì€ ì—†ëŠ”ê°€ìš”?**

### ê³¼ì œ 4: ì‹¤ìŠµ - ì»¤ìŠ¤í…€ API ì¶”ê°€

ì‹œìŠ¤í…œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ìƒˆë¡œìš´ APIë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”:

**1ë‹¨ê³„: Main Processì— í•¸ë“¤ëŸ¬ ì¶”ê°€**
```typescript
// main.tsì— ì¶”ê°€
ipcMain.handle('get-system-info', async () => {
  return {
    platform: process.platform,
    arch: process.arch,
    nodeVersion: process.version,
    electronVersion: process.versions.electron,
    chromeVersion: process.versions.chrome
  };
});
```

**2ë‹¨ê³„: Preloadì— API ì¶”ê°€**
```typescript
// preload.tsì— ì¶”ê°€
const electronAPI = {
  // ê¸°ì¡´ APIë“¤...
  getSystemInfo: () => ipcRenderer.invoke('get-system-info'),
};
```

**3ë‹¨ê³„: Rendererì—ì„œ ì‚¬ìš©**
```typescript
// ì½˜ì†”ì—ì„œ í…ŒìŠ¤íŠ¸
await window.electronAPI.getSystemInfo();
```

**ë„ì „ ê³¼ì œ:**
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì •ë³´ ì¶”ê°€
- CPU ì •ë³´ ì¶”ê°€  
- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ êµ¬í˜„

## ì¶”ê°€ í•™ìŠµ ìë£Œ

### ë³´ì•ˆê³¼ Context Isolation
- [Electron ë³´ì•ˆ ê°€ì´ë“œ](https://www.electronjs.org/docs/latest/tutorial/security)
- [Context Isolation ì‹¬í™”](https://www.electronjs.org/docs/latest/tutorial/context-isolation)
- [Preload Script ê°€ì´ë“œ](https://www.electronjs.org/docs/latest/tutorial/tutorial-preload)

### IPC í†µì‹  íŒ¨í„´
- [IPC ë©”ì¸-ë Œë”ëŸ¬ í†µì‹ ](https://www.electronjs.org/docs/latest/tutorial/ipc)
- [IPC ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€](https://www.electronjs.org/docs/latest/tutorial/ipc#security-considerations)

### TypeScript í†µí•©
- [Electron TypeScript ì„¤ì •](https://www.electronjs.org/docs/latest/tutorial/typescript)

### ë‹¤ìŒ í•™ìŠµ ì˜ˆê³ 
**5ì¼ì°¨ì—ì„œëŠ” Context Bridgeì™€ ë³´ì•ˆ ëª¨ë¸ì„ ë” ê¹Šì´ í•™ìŠµí•©ë‹ˆë‹¤. ë³´ì•ˆ ìœ„í—˜ìš”ì†Œë“¤ê³¼ ë°©ì–´ ê¸°ë²•, ê·¸ë¦¬ê³  ì•ˆì „í•œ API ì„¤ê³„ ì›ì¹™ì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤.**

---
*ğŸ¯ í•™ìŠµ íŒ: Preload ScriptëŠ” Electronì˜ ë³´ì•ˆ ëª¨ë¸ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì…ë‹ˆë‹¤. Context Bridge íŒ¨í„´ì„ ì™„ì „íˆ ì´í•´í•˜ëŠ” ê²ƒì´ ì•ˆì „í•œ Electron ì•± ê°œë°œì˜ í•µì‹¬ì´ì—ìš”!*